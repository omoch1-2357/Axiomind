name: CI

on:
  push:
    branches: [main, rust-web-server, develop]
  pull_request:
    branches: [main, rust-web-server]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ========================================
  # Job 1: Test Suite - Rust unit & integration tests
  # ========================================
  # Purpose: Validate Rust business logic, API contracts, data serialization
  # Dependencies: None (runs independently)
  # Success Criteria: All 178+ Rust tests pass on Linux/macOS/Windows × stable/beta
  # Note: Does NOT validate frontend (JavaScript, htmx, browser behavior)
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]
        include:
          - os: ubuntu-latest
            rust: beta
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust ${{ matrix.rust }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.rust }}-
            ${{ runner.os }}-cargo-

      - name: Run tests
        run: cargo test --workspace --all-features --verbose

      - name: Run doc tests
        run: cargo test --workspace --doc --verbose

  # ========================================
  # Job 2: Rustfmt - Code formatting validation
  # ========================================
  # Purpose: Enforce consistent Rust code style
  # Dependencies: None (runs independently)
  # Success Criteria: cargo fmt --check exits with code 0 (no formatting changes needed)
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  # ========================================
  # Job 3: Clippy - Rust linting
  # ========================================
  # Purpose: Catch common Rust mistakes, code smells, and enforce best practices
  # Dependencies: None (runs independently)
  # Success Criteria: cargo clippy exits with code 0, treating warnings as errors (-D warnings)
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Run clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  # ========================================
  # Job 4: Frontend Lint - JavaScript static analysis
  # ========================================
  # Purpose: Detect JavaScript syntax errors, enforce coding standards (ESLint)
  # Dependencies: None (runs independently)
  # Success Criteria: ESLint passes with zero errors, all .js files have valid syntax
  # Critical: This job catches errors that Rust tests CANNOT detect (2025-11-02 incident)
  frontend-lint:
    name: JavaScript Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check JavaScript syntax
        run: |
          echo "Checking JavaScript files for syntax errors..."
          find rust/web/static -name "*.js" -type f -exec node --check {} \;

  # ========================================
  # Job 5: Browser E2E Tests - Complete integration validation
  # ========================================
  # Purpose: Validate full user flows in real browser (Playwright)
  # Dependencies: test (Rust tests must pass), frontend-lint (ESLint must pass)
  # Success Criteria: All E2E tests pass, no JavaScript console errors, correct Content-Type headers
  # Critical: This is the ONLY test that validates the app works for end users
  # Coverage: Game start, SSE events, form submissions, error handling, static assets
  frontend-e2e:
    name: Browser E2E Tests
    runs-on: ubuntu-latest
    needs: [test, frontend-lint]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build Rust web server
        run: cargo build --release -p axm_web

      - name: Run Playwright tests
        run: npm run test:e2e
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          
  # ========================================
  # Job 6: Build Release Binary - Multi-platform builds
  # ========================================
  # Purpose: Create optimized release binaries for distribution
  # Dependencies: None (runs independently)
  # Success Criteria: Binaries build successfully for Linux/macOS (x64 + ARM)/Windows
  # Artifacts: Uploaded to GitHub Actions artifacts (30 days retention)
  build-release:
    needs: [fmt, clippy]
    name: Build Release Binary
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: axm-linux-amd64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: axm-macos-amd64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: axm-macos-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: axm-windows-amd64.exe
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --bin axm --target ${{ matrix.target }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: target/${{ matrix.target }}/release/axm${{ matrix.os == 'windows-latest' && '.exe' || '' }}
          if-no-files-found: error

  # ========================================
  # Job 7: Rustdoc - API documentation generation
  # ========================================
  # Purpose: Generate comprehensive API documentation for all workspace crates
  # Dependencies: None (runs independently)
  # Success Criteria: Documentation builds successfully, artifacts uploaded
  # Coverage: Generates docs for axm_engine, axm_cli, axm_web (public APIs only)
  rustdoc:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-doc-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-doc-
            ${{ runner.os }}-cargo-

      - name: Build documentation
        run: cargo doc --workspace --no-deps --verbose

      - name: Generate index.html
        run: bash scripts/generate-doc-index.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: target/doc
          retention-days: 30
          if-no-files-found: error

  # ========================================
  # Job 8: Validate Documentation Quality
  # ========================================
  # Purpose: Validate documentation quality and detect broken links
  # Dependencies: None (runs independently)
  # Success Criteria: No broken links, no documentation comment syntax errors
  # Coverage: Checks all workspace crates for link errors and missing docs
  # Note: doctest validation is handled by the test job (cargo test --doc)
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-validate-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-validate-docs-
            ${{ runner.os }}-cargo-

      - name: Check documentation links (axm-engine)
        run: |
          echo "Checking axm-engine documentation for broken links..."
          cargo rustdoc -p axm-engine --lib -- -D warnings
        continue-on-error: false

      - name: Check documentation links (axm_cli)
        run: |
          echo "Checking axm_cli documentation for broken links..."
          cargo rustdoc -p axm_cli --lib -- -D warnings
        continue-on-error: false

      - name: Check documentation links (axm_web)
        run: |
          echo "Checking axm_web documentation for broken links..."
          cargo rustdoc -p axm_web --lib -- -D warnings
        continue-on-error: false

      - name: Check for missing documentation
        run: |
          echo "Checking for public items without documentation..."
          set -o pipefail
          cargo doc --workspace --no-deps 2>&1 | tee doc_output.log

          echo ""
          echo "=== Documentation Coverage Report ==="

          # Count missing documentation warnings
          MISSING_DOCS=$(grep -c "warning.*missing documentation" doc_output.log || true)

          if [ "$MISSING_DOCS" -gt 0 ]; then
            echo "⚠️  Found $MISSING_DOCS items without documentation:"
            grep "warning.*missing documentation" doc_output.log || true
            echo ""
            echo "Note: While not a CI failure, please add documentation to public APIs."
          else
            echo "✓ All public APIs have documentation"
          fi

          # This is informational only, not a failure
          exit 0